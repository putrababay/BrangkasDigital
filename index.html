<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ultimate Secure Vault</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet" />
    <link
      href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css"
      rel="stylesheet" />
    <link
      href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css"
      rel="stylesheet" />
    <link
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
      rel="stylesheet" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet" />

    <style>
      body {
        background: #121212;
        color: #e0e0e0;
        font-family: Segoe UI;
        padding: 15px;
      }
      .container {
        background: #1e1e1e;
        padding: 20px;
        border-radius: 15px;
        border: 1px solid #333;
      }
      .form-control {
        background: #2d2d2d !important;
        border: 1px solid #444 !important;
        color: #fff !important;
      }
      .input-group-text {
        background: #333;
        border: 1px solid #444;
        color: #0dcaf0;
        cursor: pointer;
      }
      .modal-content {
        background: #1e1e1e;
        border: 1px solid #444;
      }
      .table-dark {
        --bs-table-bg: #1e1e1e;
        font-size: 0.85rem;
      }
      .swal-mini-input {
        width: 85% !important;
        margin: 10px auto !important;
        text-align: center;
      }
      #loginOverlay {
        position: fixed;
        inset: 0;
        background: #0f0f0f;
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .login-card {
        width: 90%;
        max-width: 320px;
        padding: 35px;
        background: #1a1a1a;
        border-radius: 20px;
        border: 1px solid #333;
        text-align: center;
      }
      .pin-input-modern {
        letter-spacing: 10px;
        font-size: 24px;
        font-weight: bold;
        background: #252525 !important;
        border: none;
        border-bottom: 2px solid #0d6efd;
        color: #0dcaf0 !important;
      }
    </style>
  </head>

  <body>
    <!-- LOGIN -->
    <div id="loginOverlay">
      <div class="login-card">
        <i class="fas fa-fingerprint fa-3x text-primary mb-3"></i>
        <h5 class="mb-4">Secure Vault</h5>
        <input
          id="pinInput"
          type="password"
          class="form-control pin-input-modern text-center mb-4"
          maxlength="6"
          placeholder="******" />
        <button class="btn btn-primary w-100" onclick="checkPin()">
          VERIFIKASI
        </button>
      </div>
    </div>

    <!-- MAIN -->
    <div id="mainApp" style="display: none">
      <div class="container">
        <div class="d-flex justify-content-between mb-3">
          <h4><i class="fas fa-vault text-warning"></i> Brankas Cloud</h4>
          <button class="btn btn-primary btn-sm" onclick="openModalAdd()">
            + Baru
          </button>
        </div>

        <table
          id="accountTable"
          class="table table-dark table-hover dt-responsive nowrap w-100">
          <thead>
            <tr>
              <th>Kategori</th>
              <th>Username</th>
              <th class="text-end">Aksi</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- MODAL FORM -->
    <div class="modal fade" id="myModal" data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5>Form Akun</h5>
            <button
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="accountForm">
              <input type="hidden" id="editId" />
              <div class="mb-2">
                <label>Kategori</label
                ><input id="kategori" class="form-control" required />
              </div>
              <div class="mb-2">
                <label>Username</label
                ><input id="username" class="form-control" required />
              </div>
              <div class="mb-2">
                <label>Password</label>
                <div class="input-group">
                  <input
                    id="password"
                    type="password"
                    class="form-control"
                    required />
                  <span
                    class="input-group-text"
                    onclick="toggleView('password')"
                    ><i class="fa fa-eye"></i
                  ></span>
                </div>
              </div>
              <button class="btn btn-success w-100">SIMPAN</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
      let VAULT = { key: null };
      let PENDING_SAVE = false;

      function toggleView(id) {
        const i = document.getElementById(id);
        i.type = i.type === "password" ? "text" : "password";
      }

      function checkPin() {
        if ($("#pinInput").val() !== "123456")
          return Swal.fire("Error", "PIN Salah", "error");
        $("#loginOverlay").fadeOut();
        $("#mainApp").show();
        renderTable();
      }

      /* === SECRET KEY PROMPT (STABIL) === */
      async function askSecret() {
        if (VAULT.key) return VAULT.key;

        const { value } = await Swal.fire({
          title: "Otorisasi",
          html: `<input id="secretKey" type="password" class="swal2-input swal-mini-input" placeholder="Secret Key">`,
          showCancelButton: true,
          allowOutsideClick: false,
          didOpen: () =>
            setTimeout(() => document.getElementById("secretKey").focus(), 100),
          preConfirm: () => {
            const v = document.getElementById("secretKey").value.trim();
            if (!v) Swal.showValidationMessage("Wajib diisi");
            return v;
          },
        });

        if (!value) return null;
        VAULT.key = value;
        return value;
      }

      /* === FORM SUBMIT === */
      $("#accountForm").on("submit", function (e) {
        e.preventDefault();
        PENDING_SAVE = true;
        $("#myModal").modal("hide");
      });

      /* === SETELAH MODAL TERTUTUP === */
      $("#myModal").on("hidden.bs.modal", async function () {
        if (!PENDING_SAVE) return;
        PENDING_SAVE = false;

        const key = await askSecret();
        if (!key) return;

        const data = JSON.parse(localStorage.getItem("vault_data") || "[]");
        const enc = (v) => CryptoJS.AES.encrypt(v, key).toString();

        const obj = {
          kategori: $("#kategori").val(),
          username: $("#username").val(),
          password: enc($("#password").val()),
        };

        const id = $("#editId").val();
        if (id === "") data.push(obj);
        else data[id] = obj;

        localStorage.setItem("vault_data", JSON.stringify(data));
        renderTable();
        Swal.fire("Sukses", "Data tersimpan", "success");
      });

      /* === TABLE === */
      function renderTable() {
        const data = JSON.parse(localStorage.getItem("vault_data") || "[]");
        $("#tableBody").html(
          data
            .map(
              (x, i) => `
    <tr>
      <td>${x.kategori}</td>
      <td>${x.username}</td>
      <td class="text-end">
        <button class="btn btn-info btn-sm" onclick="view(${i})"><i class="fa fa-eye"></i></button>
        <button class="btn btn-warning btn-sm" onclick="edit(${i})"><i class="fa fa-edit"></i></button>
      </td>
    </tr>`
            )
            .join("")
        );
        if ($.fn.DataTable.isDataTable("#accountTable"))
          $("#accountTable").DataTable().destroy();
        $("#accountTable").DataTable({ responsive: true, lengthChange: false });
      }

      async function view(i) {
        const key = await askSecret();
        if (!key) return;
        const d = JSON.parse(localStorage.getItem("vault_data"))[i];
        try {
          const p = CryptoJS.AES.decrypt(d.password, key).toString(
            CryptoJS.enc.Utf8
          );
          Swal.fire("Detail", `<b>${d.username}</b><br>${p}`, "info");
        } catch {
          VAULT.key = null;
          Swal.fire("Error", "Secret Key Salah", "error");
        }
      }

      async function edit(i) {
        const key = await askSecret();
        if (!key) return;
        const d = JSON.parse(localStorage.getItem("vault_data"))[i];
        $("#editId").val(i);
        $("#kategori").val(d.kategori);
        $("#username").val(d.username);
        $("#password").val(
          CryptoJS.AES.decrypt(d.password, key).toString(CryptoJS.enc.Utf8)
        );
        $("#myModal").modal("show");
      }

      function openModalAdd() {
        $("#editId").val("");
        $("#accountForm")[0].reset();
        $("#myModal").modal("show");
      }
    </script>
  </body>
</html>
