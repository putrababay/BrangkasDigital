<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ultimate Secure Vault - Cloud D1</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

    <style>
      /* Base Theme */
      body {
        background-color: #121212;
        color: #e0e0e0;
        padding: 10px;
        font-family: "Segoe UI", sans-serif;
      }
      .container {
        background: #1e1e1e;
        padding: 15px;
        border-radius: 12px;
        border: 1px solid #333;
        max-width: 100%;
      }

      /* Input Styling */
      .form-control,
      .form-select {
        background-color: #2d2d2d !important;
        border: 1px solid #444 !important;
        color: #ffffff !important;
        font-size: 0.9rem;
      }
      .form-control:focus {
        background-color: #333 !important;
        border-color: #0d6efd;
        box-shadow: none;
        color: white;
      }
      .input-group-text {
        background-color: #333;
        border: 1px solid #444;
        color: #0dcaf0;
        cursor: pointer;
      }

      /* Modal & Table */
      .modal-content {
        background-color: #1e1e1e;
        color: white;
        border: 1px solid #444;
      }
      .table-dark {
        --bs-table-bg: #1e1e1e;
        font-size: 0.85rem;
      }

      /* Mobile Optimization for Table */
      @media (max-width: 576px) {
        .dtr-details {
          width: 100%;
        }
        #accountTable thead {
          display: none;
        } /* Hide header on mobile for minimalism */
        #accountTable tr {
          border-bottom: 1px solid #333;
          display: block;
          margin-bottom: 10px;
        }
        #accountTable td {
          display: block;
          text-align: left !important;
          border: none;
          padding: 5px 0;
        }
        #accountTable td:last-child {
          text-align: right !important;
          margin-top: -35px;
        } /* Pull buttons up */
      }

      /* Login Overlay Modern */
      #loginOverlay {
        position: fixed;
        inset: 0;
        background: #0f0f0f;
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .login-card {
        width: 90%;
        max-width: 320px;
        padding: 40px 25px;
        background: #1a1a1a;
        border-radius: 20px;
        border: 1px solid #333;
        text-align: center;
      }
      .pin-input-modern {
        letter-spacing: 10px;
        font-size: 24px;
        font-weight: bold;
        background: #252525 !important;
        border: none !important;
        border-bottom: 2px solid #0d6efd !important;
        border-radius: 0;
        color: #0dcaf0 !important;
      }

      /* Minimalist Secret Key Input for Swal */
      .swal-mini-input {
        background: #2d2d2d !important;
        color: #fff !important;
        border: 1px solid #444 !important;
        border-radius: 8px !important;
        font-size: 14px !important;
      }
    </style>
  </head>
  <body>
    <div id="loginOverlay">
      <div class="login-card shadow-lg">
        <div class="mb-3">
          <i class="fas fa-fingerprint fa-3x text-primary"></i>
        </div>
        <h5 class="mb-4">Secure Vault</h5>
        <input
          type="password"
          id="pinInput"
          class="form-control text-center pin-input-modern mb-4"
          maxlength="6"
          placeholder="******" />
        <button
          class="btn btn-primary w-100 rounded-pill py-2"
          onclick="checkPin()">
          VERIFIKASI ACCESS
        </button>
      </div>
    </div>

    <div id="mainApp" style="display: none">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="m-0"><i class="fas fa-vault text-warning"></i> Brankas</h5>
          <div class="dropdown">
            <button
              class="btn btn-outline-secondary btn-sm"
              type="button"
              data-bs-toggle="dropdown">
              <i class="fas fa-cog"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
              <li>
                <a class="dropdown-item" href="#" onclick="openModalAdd()"
                  ><i class="fas fa-plus me-2"></i>Tambah Baru</a
                >
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a
                  class="dropdown-item"
                  href="#"
                  onclick="updateSecurity('login')"
                  ><i class="fas fa-lock me-2"></i>Update PIN Login</a
                >
              </li>
              <li>
                <a
                  class="dropdown-item"
                  href="#"
                  onclick="updateSecurity('secret')"
                  ><i class="fas fa-key me-2"></i>Update Secret Key</a
                >
              </li>
            </ul>
          </div>
        </div>

        <table id="accountTable" class="table table-dark table-hover w-100">
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div
      class="modal fade"
      id="myModal"
      tabindex="-1"
      aria-hidden="true"
      data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-secondary py-2">
            <h6 class="modal-title" id="modalTitle">Form Data</h6>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="accountForm">
              <input type="hidden" id="editId" />
              <div class="mb-2">
                <label class="small text-secondary"
                  >Kategori / Nama Aplikasi</label
                >
                <input
                  type="text"
                  id="kategori"
                  class="form-control form-control-sm"
                  placeholder="Contoh: Facebook"
                  required />
              </div>
              <div class="mb-2">
                <label class="small text-secondary">Username / Email</label>
                <input
                  type="text"
                  id="username"
                  class="form-control form-control-sm"
                  required />
              </div>
              <div class="mb-2">
                <label class="small text-secondary">Password</label>
                <div class="input-group input-group-sm">
                  <input
                    type="password"
                    id="password"
                    class="form-control"
                    required />
                  <span
                    class="input-group-text"
                    onclick="toggleView('password')"
                    ><i class="fas fa-eye"></i
                  ></span>
                </div>
              </div>
              <div class="row g-2">
                <div class="col-6 mb-2">
                  <label class="small text-secondary">PIN</label>
                  <div class="input-group input-group-sm">
                    <input type="password" id="pin" class="form-control" />
                    <span class="input-group-text" onclick="toggleView('pin')"
                      ><i class="fas fa-eye"></i
                    ></span>
                  </div>
                </div>
                <div class="col-6 mb-2">
                  <label class="small text-secondary">Pola</label>
                  <div class="input-group input-group-sm">
                    <input type="password" id="pola" class="form-control" />
                    <span class="input-group-text" onclick="toggleView('pola')"
                      ><i class="fas fa-eye"></i
                    ></span>
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label class="small text-secondary">Catatan</label>
                <textarea
                  id="riwayat"
                  class="form-control form-control-sm"
                  rows="2"></textarea>
              </div>
              <button
                type="submit"
                class="btn btn-success btn-sm w-100 fw-bold">
                ENKRIPSI & SIMPAN
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
      $(document).ready(function () {
        if (sessionStorage.getItem("vault_auth") === "true") showApp();
      });

      function toggleView(id) {
        const input = document.getElementById(id);
        input.type = input.type === "password" ? "text" : "password";
      }

      async function checkPin() {
        const pin = $("#pinInput").val();
        const hash = CryptoJS.SHA256(pin).toString();
        const res = await fetch("/api/verify-pin", {
          method: "POST",
          body: JSON.stringify({ pin: hash }),
        });
        if (res.ok) {
          sessionStorage.setItem("vault_auth", "true");
          showApp();
        } else {
          Swal.fire({
            icon: "error",
            title: "Akses Ditolak",
            text: "PIN Salah!",
            background: "#1e1e1e",
            color: "#fff",
          });
        }
      }

      function showApp() {
        $("#loginOverlay").fadeOut();
        $("#mainApp").show();
        renderTable();
      }

      // 1. Perbaikan Input Secret Key Lebih Minimalis
      async function askSecret() {
        const { value: key } = await Swal.fire({
          title: "Verify Secret Key",
          input: "password",
          inputAttributes: { autocapitalize: "off", class: "swal-mini-input" },
          showCancelButton: true,
          confirmButtonText: "Buka",
          background: "#1a1a1a",
          color: "#fff",
          customClass: { input: "form-control swal-mini-input" },
        });
        return key;
      }

      // 3 & 4. Perbaikan Tabel Minimalis (Hapus teks 'Aksi' dan mode ponsel)
      async function renderTable() {
        const response = await fetch("/api/accounts");
        const data = await response.json();

        let html = "";
        data.forEach((item) => {
          html += `<tr>
                <td>
                    <div class="fw-bold text-info">${item.kategori}</div>
                    <div class="small text-secondary">${item.username}</div>
                </td>
                <td class="text-end">
                    <div class="btn-group">
                        <button class="btn btn-sm text-info" onclick="handleAction(${item.id}, 'view')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm text-warning" onclick="handleAction(${item.id}, 'edit')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm text-danger" onclick="handleAction(${item.id}, 'delete')"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>`;
        });
        $("#tableBody").html(html);
        if (!$.fn.DataTable.isDataTable("#accountTable")) {
          $("#accountTable").DataTable({
            responsive: true,
            pageLength: 25,
            dom: "ftip", // Minimalist dom
            language: { search: "", searchPlaceholder: "Cari..." },
          });
        }
      }

      async function handleAction(id, type) {
        const key = await askSecret();
        if (!key) return;

        const response = await fetch("/api/accounts");
        const db = await response.json();
        const item = db.find((x) => x.id === id);

        try {
          if (type === "view" || type === "edit") {
            const pass = CryptoJS.AES.decrypt(item.password, key).toString(
              CryptoJS.enc.Utf8
            );
            if (!pass) throw new Error();

            const pin = item.pin
              ? CryptoJS.AES.decrypt(item.pin, key).toString(CryptoJS.enc.Utf8)
              : "-";
            const pola = item.pola
              ? CryptoJS.AES.decrypt(item.pola, key).toString(CryptoJS.enc.Utf8)
              : "-";

            if (type === "view") {
              Swal.fire({
                title: item.kategori,
                background: "#1e1e1e",
                color: "#fff",
                html: `<div class="text-start bg-dark p-3 rounded small">
                        <div class="mb-1"><b>User:</b> ${item.username}</div>
                        <div class="mb-1"><b>Pass:</b> ${pass}</div>
                        <div class="mb-1"><b>PIN:</b> ${pin}</div>
                        <div class="mb-1"><b>Pola:</b> ${pola}</div>
                        <hr class="my-2 border-secondary">
                        <div class="text-secondary">${item.riwayat || ""}</div>
                       </div>`,
              });
            } else {
              $("#editId").val(item.id);
              $("#kategori").val(item.kategori);
              $("#username").val(item.username);
              $("#password").val(pass);
              $("#pin").val(pin === "-" ? "" : pin);
              $("#pola").val(pola === "-" ? "" : pola);
              $("#riwayat").val(item.riwayat);
              $("#modalTitle").text("Edit Akun");
              $("#myModal").modal("show");
            }
          } else if (type === "delete") {
            const confirm = await Swal.fire({
              title: "Hapus Data?",
              icon: "warning",
              showCancelButton: true,
              background: "#1e1e1e",
              color: "#fff",
            });
            if (confirm.isConfirmed) {
              await fetch(`/api/accounts?id=${id}`, { method: "DELETE" });
              renderTable();
            }
          }
        } catch (e) {
          Swal.fire({
            icon: "error",
            title: "Gagal",
            text: "Secret Key Salah!",
            background: "#1e1e1e",
            color: "#fff",
          });
        }
      }

      $("#accountForm").on("submit", async function (e) {
        e.preventDefault();
        const key = await askSecret();
        if (!key) return;

        const data = {
          id: $("#editId").val(),
          kategori: $("#kategori").val(),
          username: $("#username").val(),
          password: CryptoJS.AES.encrypt($("#password").val(), key).toString(),
          pin: $("#pin").val()
            ? CryptoJS.AES.encrypt($("#pin").val(), key).toString()
            : "",
          pola: $("#pola").val()
            ? CryptoJS.AES.encrypt($("#pola").val(), key).toString()
            : "",
          riwayat: $("#riwayat").val(),
        };

        const res = await fetch("/api/accounts", {
          method: "POST",
          body: JSON.stringify(data),
        });
        if (res.ok) {
          $("#myModal").modal("hide");
          renderTable();
          Swal.fire({
            icon: "success",
            title: "Berhasil",
            text: "Data Terenkripsi",
            background: "#1e1e1e",
            color: "#fff",
            timer: 1500,
          });
        }
      });

      // 2. Tambahkan Menu Update PIN Login & Secret Key
      async function updateSecurity(type) {
        const title =
          type === "login" ? "Update PIN Login" : "Update Secret Key";
        const labelOld = type === "login" ? "PIN Lama" : "Secret Key Lama";
        const labelNew = type === "login" ? "PIN Baru" : "Secret Key Baru";

        const { value: formValues } = await Swal.fire({
          title: title,
          background: "#1e1e1e",
          color: "#fff",
          html:
            `<input id="swal-input1" class="swal2-input swal-mini-input" type="password" placeholder="${labelOld}">` +
            `<input id="swal-input2" class="swal2-input swal-mini-input" type="password" placeholder="${labelNew}">`,
          focusConfirm: false,
          preConfirm: () => [
            document.getElementById("swal-input1").value,
            document.getElementById("swal-input2").value,
          ],
        });

        if (formValues) {
          const [oldVal, newVal] = formValues;
          const endpoint =
            type === "login" ? "/api/update-pin" : "/api/update-secret";

          // Hash specifically for login pin
          const payload =
            type === "login"
              ? {
                  old: CryptoJS.SHA256(oldVal).toString(),
                  new: CryptoJS.SHA256(newVal).toString(),
                }
              : { old: oldVal, new: newVal };

          const res = await fetch(endpoint, {
            method: "POST",
            body: JSON.stringify(payload),
          });
          if (res.ok)
            Swal.fire({
              icon: "success",
              title: "Sukses",
              text: "Keamanan diperbarui",
              background: "#1e1e1e",
              color: "#fff",
            });
          else
            Swal.fire({
              icon: "error",
              title: "Gagal",
              text: "Data lama tidak cocok",
              background: "#1e1e1e",
              color: "#fff",
            });
        }
      }

      function openModalAdd() {
        $("#editId").val("");
        $("#accountForm")[0].reset();
        $("#modalTitle").text("Tambah Baru");
        $("#myModal").modal("show");
      }
    </script>
  </body>
</html>
